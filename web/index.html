<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Hand Debug Live</title>
  <style>
    body { margin:0; display:flex; height:100vh; background:#111; color:#eee; align-items:center; justify-content:center; }
    #wrap { position:relative; width: 720px; height: 540px; }
    video, canvas { position:absolute; left:0; top:0; width:100%; height:100%; }
    video { z-index:1; }
    canvas { z-index:2; pointer-events:none; }
    #hint { position:absolute; left:8px; top:8px; background:#0008; padding:6px 10px; border-radius:8px; font:14px/1.3 system-ui; z-index:3; }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div id="hint">Live: MediaPipe Hands (MCP=파랑, PIP=노랑, TIP=빨강)</div>
  </div>

  <!-- 1) Mediapipe CDN: 반드시 먼저 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <!-- 2) 전역 심볼 안전하게 바인딩 -->
  <script>
    const Hands            = window.Hands;
    const Camera           = window.Camera;
    const drawConnectors   = window.drawConnectors;
    const drawLandmarks    = window.drawLandmarks;
    const HAND_CONNECTIONS = window.HAND_CONNECTIONS;
  </script>

  <!-- 3) 메인 스크립트 -->
  <script>
    const video  = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');

    const FINGERS_TIP = [8, 12, 16, 20];
    const FINGERS_PIP = [6, 10, 14, 18];
    const FINGERS_MCP = [5,  9, 13, 17];

    function drawMcpPipTipRaw(ctx, lm, w, h) {
      const toXY = (p) => [p.x * w, p.y * h];
      for (let k = 0; k < 4; k++) {
        const [mx,my] = toXY(lm[FINGERS_MCP[k]]);
        const [px,py] = toXY(lm[FINGERS_PIP[k]]);
        const [tx,ty] = toXY(lm[FINGERS_TIP[k]]);
        // 선
        ctx.lineWidth = 3; ctx.strokeStyle = 'rgb(255,255,0)';
        ctx.beginPath(); ctx.moveTo(mx,my); ctx.lineTo(px,py); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(tx,ty); ctx.stroke();
        // 점
        const dot = (x,y,c) => { ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill(); };
        dot(mx,my,'rgb(0,128,255)');  // MCP
        dot(px,py,'rgb(255,255,0)');  // PIP
        dot(tx,ty,'rgb(255,64,64)');  // TIP
      }
    }

    // Mediapipe Hands 인스턴스
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({
      selfieMode: true,
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    hands.onResults((results) => {
      const w = canvas.width  = video.videoWidth  || 640;
      const h = canvas.height = video.videoHeight || 480;

      ctx.clearRect(0,0,w,h);
      ctx.drawImage(results.image, 0, 0, w, h);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
        const lm = results.multiHandLandmarks[0];

        // A) 기본 뼈대 (있으면 사용)
        if (typeof drawConnectors === 'function' && typeof drawLandmarks === 'function' && HAND_CONNECTIONS) {
          drawConnectors(ctx, lm, HAND_CONNECTIONS, { color: '#00FFAA', lineWidth: 2 });
          drawLandmarks(ctx, lm, { color: '#00D4FF', lineWidth: 1, radius: 2 });
        }
        // B) 우리가 직접 그리는 MCP/PIP/TIP (항상)
        drawMcpPipTipRaw(ctx, lm, w, h);
      }
    });

    // 카메라 시작
    (async () => {
      // 127.0.0.1 로 열어야 getUserMedia 보안 통과가 안전함
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 720, height: 540 }});
      video.srcObject = stream;
      await video.play();

      const camera = new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 720, height: 540
      });
      camera.start();
    })().catch(err => {
      console.error(err);
      alert('카메라 권한을 허용해 주세요.\n' + err);
    });
  </script>

<div id="api" style="position:absolute;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;z-index:4;font:14px system-ui">
  server: <span id="server">checking…</span> |
  gesture: <span id="gesture">-</span> |
  vs: <span id="computer">-</span> |
  result: <span id="result">-</span>
</div>
</body>
</html>
